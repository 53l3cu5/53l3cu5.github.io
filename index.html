<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration du Détecteur de Mouvement</title>
    <style>
        .indent {
            margin-left: 20px; /* Ajustez la valeur de la marge selon vos besoins */
        }
        .required::after {
            content: " *";
            color: red;
        }
        /* CSS pour l'animation du message de confirmation */
        .copy-message {
            position: fixed;
            background-color: #28a745; /* Vert */
            color: white;
            padding: 6px 10px; /* Réduire la taille */
            border-radius: 5px;
            animation: fadeOut 3s ease-in-out forwards;
            display: none;
        }
        .copy-button {
            background-color: rgba(0, 123, 255, 0.5); /* Bleu transparent */
            border: none;
            color: white;
            padding: 4px 8px; /* Réduire la taille */
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px; /* Réduire la taille du texte */
            margin: 2px 0;
            cursor: pointer;
            border-radius: 5px; /* Rend les boutons plus arrondis */
            transition: background-color 0.3s; /* Transition de couleur au survol */
            opacity: 0.7; /* Transparence initiale */
        }
        .copy-button:hover {
            background-color: rgba(0, 123, 255, 1); /* Changement de couleur au survol */
            opacity: 1; /* Opacité au survol */
        }
        .generate-button {
            background-color: #28a745; /* Vert */
            border: none;
            color: white;
            padding: 8px 16px; /* Réduire la taille */
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px; /* Réduire la taille du texte */
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 10px; /* Rend les boutons plus arrondis */
            transition: background-color 0.3s; /* Transition de couleur au survol */
        }
        .generate-button:hover {
            background-color: #218838; /* Changement de couleur au survol */
        }
        textarea {
            border-radius: 5px; /* Rend les coins des zones de texte plus arrondis */
            border: 1px solid #ced4da; /* Ajoute une bordure légère */
            padding: 10px; /* Ajoute de l'espace à l'intérieur des zones de texte */
            resize: none; /* Empêche le redimensionnement de la zone de texte */
            margin-bottom: 10px; /* Ajoute un espacement en bas des zones de texte */
            font-size: 14px; /* Définit la taille de la police */
        }
    </style>
</head>
<body>
    <header>
        <h1>LD2450 motion detector configuration</h1>
    </header>
    <main>
        <form id="config-form"> 
            <label for="devicename" class="required">Device Name:</label>
            <input type="text" id="devicename" name="devicename" placeholder="hpsz-room" required>
            <br>
            <label for="friendly_name" class="required indent">Friendly Name:</label>
            <input type="text" id="friendly_name" name="friendly_name" placeholder="Room" required>
            <br>
            <label for="entity_name" class="indent">Entity Name:</label>
            <input type="text" id="entity_name" name="entity_name" title="Leave empty if you want entities named 'Target...' otherwise put 'Room' to have an entity named 'Room Target...'">
            <br>
            <input type="text" id="for_graph" name="for_graph" class="indent" style="display: none" readonly>
            <br>
            <label for="api-key">Encryption key (optional):</label>
            <input type="text" id="api-key" name="api-key" onclick="this.focus();this.select()" style="width: 370px; max-width: 75vw;">
            <br>
            <br>
            <label for="zone-detection">Number of detection zones:</label>
            <select id="zone-detection" name="zone-detection">
                <!-- Ajout des options de 1 à 10 -->
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6" selected>6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <br>
            <label for="cible-quitter-zone" class="indent">Target must leave zone:</label>
            <select id="cible-quitter-zone" name="cible-quitter-zone">
                <!-- Options générées dynamiquement en JavaScript -->
            </select>
            <br>
            <br>
            <label for="zone-exclusion">Number of exclusion zones:</label>
            <select id="zone-exclusion" name="zone-exclusion">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>
            <br><br>
            <input type="submit" class="generate-button" value="Generate">
            <br><br>
            <div id="generated-zone" style="display: none; flex-direction: row;">
                <div style="position: relative;">
                    <label for="generated-yaml-text">YAML Text:</label>
                    <div style="position: relative;">
                        <textarea id="generated-yaml-text" rows="10" cols="50" style="display: block" readonly></textarea>
                        <button class="copy-button" data-target="generated-yaml-text" style="position: absolute; top: 5px; right: 5px;">Copy</button>
                    </div>
                    <a id="download-yaml-link" style="display: none" download="LD2450.yaml">Download YAML</a>
                </div>
                <div style="position: relative;">
                    <label for="zone-h-text">Zone.h Text:</label>
                    <div style="position: relative;">
                        <textarea id="zone-h-text" rows="10" cols="50" style="display: block" readonly></textarea>
                        <button class="copy-button" data-target="zone-h-text" style="position: absolute; top: 5px; right: 5px;">Copy</button>
                    </div>
                    <a id="download-zone-link" style="display: none" download="zone.h">Download Zone.h</a> 
                </div>
                <div style="position: relative;">
                    <label for="generated-graph-text">Plotly Graph Text:</label>
                    <div style="position: relative;">
                        <textarea id="generated-graph-text" rows="10" cols="50" style="display: block" readonly></textarea>
                        <button class="copy-button" data-target="generated-graph-text" style="position: absolute; top: 5px; right: 5px;">Copy</button>
                    </div>
                    <a id="download-graph-link" style="display: none" download="Plotly Graph.txt">Download Plotly Graph</a> 
                </div>
            </div>
        </form>
        <br>
    </main>
    <footer>
        <p>© 2024 LD2450 motion detector configuration</p>
    </footer>
    <!-- Zone pour afficher le message de confirmation -->
    <div id="copyMessage" class="copy-message"></div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const zoneDetectionSelect = document.getElementById('zone-detection');
            const cibleQuitterZoneSelect = document.getElementById('cible-quitter-zone');

            zoneDetectionSelect.addEventListener('change', function () {
                const selectedOptionValue = parseInt(zoneDetectionSelect.value);
                updateCibleQuitterZoneOptions(selectedOptionValue);
            });

            function updateCibleQuitterZoneOptions(numOptions) {
                // Effacer les options actuelles
                cibleQuitterZoneSelect.innerHTML = '';
                // Ajouter de nouvelles options
                for (let i = 0; i <= numOptions; i++) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.textContent = i.toString();
                    if (i == 1) option.selected = true;
                    cibleQuitterZoneSelect.appendChild(option);
                }
            }

            // Initialiser les options de la liste déroulante dès le chargement de la page
            updateCibleQuitterZoneOptions(parseInt(zoneDetectionSelect.value));
        });

        document.addEventListener('DOMContentLoaded', function () {
            const copyButtons = document.querySelectorAll('.copy-button');
            const generateButton = document.querySelector('.generate-button');
            const generatedZone = document.getElementById('generated-zone');

            copyButtons.forEach(function(copyButton) {
                copyButton.addEventListener('click', function(event) {
                    const targetId = this.getAttribute('data-target');
                    const targetTextarea = document.getElementById(targetId);
                    const copyMessage = document.getElementById('copyMessage');
                    copyMessage.textContent = 'Texte copié !';

                    // Positionner le message à côté du bouton cliqué
                    const buttonRect = this.getBoundingClientRect();
                    copyMessage.style.left = (buttonRect.right + 10) + 'px';
                    copyMessage.style.top = (buttonRect.top + window.scrollY + 10) + 'px';

                    copyMessage.style.display = 'block';
                    // Animation CSS pour afficher le message
                    setTimeout(function() {
                        copyMessage.style.display = 'none';
                    }, 3000); // Disparition du message après 3 secondes

                    // Copie du texte dans le presse-papiers
                    targetTextarea.select();
                    document.execCommand('copy');
                });
            });

            generateButton.addEventListener('click', function() {
                const deviceName = document.getElementById('devicename').value;
                const friendlyName = document.getElementById('friendly_name').value;
                if (deviceName != '' && friendlyName != '') {
                    generatedZone.style.display = 'flex';
                }
            });
        });
        
      // https://stackoverflow.com/a/62362724
      function bytesArrToBase64(arr) {
        const abc = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"; // base64 alphabet
        const bin = n => n.toString(2).padStart(8,0); // convert num to 8-bit binary string
        const l = arr.length
        let result = '';

        for(let i=0; i<=(l-1)/3; i++) {
          let c1 = i*3+1>=l; // case when "=" is on end
          let c2 = i*3+2>=l; // case when "=" is on end
          let chunk = bin(arr[3*i]) + bin(c1? 0:arr[3*i+1]) + bin(c2? 0:arr[3*i+2]);
          let r = chunk.match(/.{1,6}/g).map((x,j)=> j==3&&c2 ? '=' :(j==2&&c1 ? '=':abc[+('0b'+x)]));
          result += r.join('');
        }

        return result;
      }

      let array = new Uint8Array(32);
      window.crypto.getRandomValues(array);
      document.getElementById("api-key").value = bytesArrToBase64(array);

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fonction pour valider les champs de texte
            function validateTextFields() {
                const deviceName = document.getElementById('devicename').value;
                const friendlyName = document.getElementById('friendly_name').value;

                if (deviceName.trim() === '') {
                    alert('Please enter a Device Name.');
                    return false;
                }

                if (friendlyName.trim() === '') {
                    alert('Please enter a Friendly Name.');
                    return false;
                }

                return true;
            }
            
            document.getElementById('config-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Valider les champs de texte
                if (!validateTextFields()) {
                    return; // Arrêter l'exécution si les champs ne sont pas valides
                }
                
                const zonesDetection = parseInt(document.getElementById('zone-detection').value);
                const zonesQuitter = parseInt(document.getElementById('cible-quitter-zone').value);
                const zonesExclusion = parseInt(document.getElementById('zone-exclusion').value);
                const devicename = document.getElementById('devicename').value;
                const friendly_name = document.getElementById('friendly_name').value;
                let entity_name = document.getElementById('entity_name').value;
                
                let for_graph_low = devicename.toLowerCase() + '_' + entity_name.toLowerCase();
                for_graph_low = for_graph_low.replace(/[-\s]+/g, '_').replace(/_+/g, '_').replace(/_$/g, '');
                if (entity_name == "") entity_name = `""`;
                
                const api_key = document.getElementById('api-key').value;

                let entete = '';
                {
                entete = `#Make on https://53l3cu5.github.io/
#Origin https://github.com/53l3cu5/ESP32_LD2450
#Inspire by https://docs.screek.io/2a
substitutions:
  devicename: ${devicename}
  friendly_name: ${friendly_name}
  entity_name: ${entity_name} # Leave empty if you want entities named "Target..." otherwise put "Room" to have an entity named "Room Target..."
  # specify below pin numbers of your LD2450
  tx_pin_ld2450: GPIO17
  rx_pin_ld2450: GPIO16
  
#ESP32/LD2450 : Human Presence Sensor by Zone
esphome:
  name: $devicename
  friendly_name: \${friendly_name}
  comment: Human Presence Sensor by Zone (ESP32/LD2450)
  #name_add_mac_suffix: True
  platformio_options:
    board_build.flash_mode: dio
    # board_build.f_cpu: 80000000L
  project: 
    name: 53l3cu5.Human_Presence_Sensor_by_Zone
    version: "2.2"
  on_boot:
    - priority: -200
      then:
        lambda: |-`;
            }
            for (let i = 1; i <= zonesDetection; i++) 
                entete += `
          id(zone${i}_target_exist).publish_state(false);`;
            for (let i = 1; i <= zonesExclusion; i++) 
                entete += `
          id(zone_ex${i}_target_exist).publish_state(false);`; 
            
            {
                entete += `
  includes:
    - zone.h
    
preferences:
    flash_write_interval: 5s
  

esp32:
  board: esp32dev

globals:
  - id: last_update_ld2450
    type: unsigned long
    restore_value: no
    initial_value: '0'
  - id: init_zone_publish
    type: bool
    restore_value: no
    initial_value: "false"

improv_serial:
  
logger:

debug:
  update_interval: 30s

api:
  encryption:
    # use your own encryption key plz.
    # https://esphome.io/components/api.html?#configuration-variables
    key: "${api_key}"
    
ota:
  # use your own ota password plz.
  password: !secret ota_password
  safe_mode: False

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: LIGHT
  reboot_timeout: 10min
  ap:
    ssid: "\${devicename} Hotspot"
    password: !secret hotspot_password

captive_portal:

web_server:
  port: 80
  
text_sensor:
  - platform: version
    name: "Version"
  - platform: debug
    reset_reason:
      name: \${entity_name} ESP Reset Reason
      icon: mdi:anchor
      disabled_by_default: True
  - platform: wifi_info
    ip_address:
      name: \${entity_name} ESP IP Address
      entity_category: "diagnostic"
      disabled_by_default: True
      icon: mdi:ip-network
    mac_address:
      name: \${entity_name} ESP MAC
      entity_category: "diagnostic"
      icon: mdi:ip-network
      disabled_by_default: True`;
          }
            // Générer le texte pour les zones de détection
            let zonesDetectionText = '';
            for (let i = 1; i <= zonesDetection; i++) {
                zonesDetectionText += `
  - platform: template
    name: \${entity_name} Zone${i} Info
    id: tips_zone${i}_conf
    icon: mdi:information-outline
    entity_category: config
    lambda: |-
      return {"Configure below" };
    update_interval: 1000s`;
            }

            // Générer le texte pour les zones d'exclusion
            let zonesExclusionText = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                zonesExclusionText += `
  - platform: template
    name: \${entity_name} Zout${i} Info
    id: tips_zone_ex${i}_conf
    icon: mdi:information-outline
    entity_category: config
    lambda: |-
      return {"Zone Exclusion ${i}" };
    update_interval: 1000s`;
            }
            let text_sensor_target = '';
            {
            text_sensor_target = `
  - platform: template
    name: \${entity_name} Any-Presence Info
    id: tips_any_presence_conf
    icon: mdi:information-outline
    entity_category: config
    lambda: |-
      return {"Any Presence Config" };
    update_interval: 1000s
  - platform: template
    name: \${entity_name} Target1 Direction
    id: target1_direction
    icon: mdi:directions
  - platform: template
    name: \${entity_name} Target2 Direction
    id: target2_direction
    icon: mdi:directions
  - platform: template
    name: \${entity_name} Target3 Direction
    id: target3_direction
    icon: mdi:directions
  - platform: template
    name: \${entity_name} Target1 Position
    id: target1_position
    icon: mdi:directions
  - platform: template
    name: \${entity_name} Target2 Position
    id: target2_position
    icon: mdi:directions
  - platform: template
    name: \${entity_name} Target3 Position
    id: target3_position
    icon: mdi:directions

number:
  - platform: template
    name: \${entity_name} Angle
    id: wall_angle
    min_value: 0
    max_value: 90
    mode: box
    device_class: duration
    entity_category: config
    unit_of_measurement: °
    icon: mdi:angle-acute
    step: 1
    optimistic: True
    initial_value: 0
    restore_value: True
  - platform: template
    name: \${entity_name} Any Presence Timeout
    id: any_presence_timeout
    min_value: 0
    max_value: 600
    mode: box
    device_class: duration
    entity_category: config
    unit_of_measurement: s
    icon: mdi:timer-off
    step: 1
    optimistic: True
    initial_value: 0
    restore_value: True`;}
            let number_zone_Timeout = '';
            for (let i = 1; i <= zonesDetection; i++) {
                number_zone_Timeout += `
  - platform: template
    name: \${entity_name} Zone${i} Timeout
    id: zone${i}_timeout
    min_value: 0
    max_value: 600
    mode: box
    device_class: duration
    entity_category: config
    unit_of_measurement: s
    icon: mdi:timer-off
    step: 1
    optimistic: True
    initial_value: 0
    restore_value: True`;
            }
            let number_zone = '';
            for (let i = 1; i <= zonesDetection; i++) {
                number_zone += `
    
  # Zone ${i}
  - platform: template
    name: \${entity_name} Zone${i} X
    id: zone${i}_x
    min_value: -4000
    max_value: 4000
    mode: box
    device_class: distance
    entity_category: config
    unit_of_measurement: mm
    icon: mdi:arrow-left-bold
    step: 10
    optimistic: True
    initial_value: 0
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zone${i}_valide
  - platform: template
    name: \${entity_name} Zone${i} Y
    id: zone${i}_y
    mode: box
    min_value: -500
    max_value: 8000
    device_class: distance
    entity_category: config
    icon: mdi:arrow-up-bold
    unit_of_measurement: mm
    step: 10
    initial_value: 0
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zone${i}_valide
  - platform: template
    name: \${entity_name} Zone${i} Height
    id: zone${i}_height
    icon: mdi:arrow-down-bold
    mode: box
    min_value: 0
    max_value: 8000
    initial_value: 0
    entity_category: config
    device_class: distance
    unit_of_measurement: mm
    step: 10
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zone${i}_valide
  - platform: template
    name: \${entity_name} Zone${i} Width
    id: zone${i}_width
    mode: box
    min_value: 0
    max_value: 8000
    device_class: distance
    unit_of_measurement: mm
    entity_category: config
    icon: mdi:arrow-right-bold
    step: 10
    initial_value: 0
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zone${i}_valide`;
            }
            
            let number_zone_ex = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                number_zone_ex += `
    
  # Zout${i}
  - platform: template
    name: \${entity_name} Zout${i} X
    id: zone_ex${i}_x
    min_value: -4000
    max_value: 4000
    mode: box
    device_class: distance
    entity_category: config
    unit_of_measurement: mm
    icon: mdi:arrow-left-bold
    step: 10
    optimistic: True
    initial_value: 0
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zout${i}_valide
  - platform: template
    name: \${entity_name} Zout${i} Y
    id: zone_ex${i}_y
    mode: box
    min_value: -500
    max_value: 8000
    device_class: distance
    entity_category: config
    icon: mdi:arrow-up-bold
    unit_of_measurement: mm
    step: 10
    initial_value: 0
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zout${i}_valide
  - platform: template
    name: \${entity_name} Zout${i} Height
    id: zone_ex${i}_height
    icon: mdi:arrow-down-bold
    mode: box
    min_value: 0
    max_value: 8000
    initial_value: 0
    entity_category: config
    device_class: distance
    unit_of_measurement: mm
    step: 10
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zout${i}_valide
  - platform: template
    name: \${entity_name} Zout${i} Width
    id: zone_ex${i}_width
    mode: box
    min_value: 0
    max_value: 8000
    device_class: distance
    unit_of_measurement: mm
    entity_category: config
    icon: mdi:arrow-right-bold
    step: 10
    initial_value: 0
    optimistic: True
    restore_value: True
    on_value: 
      then:
        - script.execute: check_zout${i}_valide`;
            }

            let binary_sensor = `

binary_sensor:
  - platform: status
    name: \${entity_name} Online
    id: ink_ha_connected
  - platform: template
    name: \${entity_name} Any Presence
    id: any_target_exist
    device_class: occupancy
    filters:
      - delayed_off: !lambda |-
          if (!id(init_zone_publish) || !id(zone_fn_enable).state) {
            return 0;
          };
          return id(any_presence_timeout).state * 1000.0;`;
            
            let binary_sensor_zone = '';
            for (let i = 1; i <= zonesDetection; i++) {
                binary_sensor_zone += `
  - platform: template
    name: \${entity_name} Zone${i} Presence
    id: zone${i}_target_exist
    device_class: occupancy
    filters:
      - delayed_off: !lambda |-
          if (!id(init_zone_publish) || !id(zone_fn_enable).state) {
            return 0;
          }
          return id(zone${i}_timeout).state * 1000.0;`;
            }
            let binary_sensor_zone_ex = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                binary_sensor_zone_ex += `
  - platform: template
    name: \${entity_name} Zout${i} Presence
    id: zone_ex${i}_target_exist
    icon: mdi:account-multiple-remove
    device_class: occupancy`;
            }
            
            let check_zone = `

script:`;
            for (let i = 1; i <= zonesDetection; i++) {
                check_zone += `
  - id: check_zone${i}_valide
    then:
      - lambda: |-
          if (id(zone${i}_x).state == 0 && id(zone${i}_width).state == 0 && id(zone${i}_y).state == 0 && id(zone${i}_height).state == 0){
            id(tips_zone${i}_conf).publish_state("Configure below");
            return;
          }

          int x_size = id(zone${i}_width).state;
          int y_size = id(zone${i}_height).state;

          char combined[80]; 
          sprintf(combined, "Curr Size: %d x %d", x_size, y_size);
          id(tips_zone${i}_conf).publish_state(combined);`;
            }
            let check_zone_ex = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                check_zone_ex += `
  - id: check_zout${i}_valide
    then:
      - lambda: |-
          id(tips_zone_ex${i}_conf).publish_state("Zone Exclusion ${i}");`;
            }
            
            let sensor_zone = `

sensor:
  - platform: uptime
    name: \${entity_name} ESP Uptime
    id: sys_uptime
    update_interval: 60s
    disabled_by_default: True
  - platform: wifi_signal 
    name: \${entity_name} RSSI
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"
    
#-------------------------------------#
  # Advanced radar data
  - platform: template
    name: \${entity_name} All Target Counts
    id: all_target_count
    accuracy_decimals: 0
    icon: "mdi:counter"
    unit_of_measurement: "targets"`;
    
            for (let i = 1; i <= zonesDetection; i++) {
                sensor_zone += `
  - platform: template
    name: \${entity_name} Zone${i} Target Counts
    id: zone${i}_target_count
    accuracy_decimals: 0
    icon: "mdi:counter"
    unit_of_measurement: "targets"`;
            }
            let sensor_zone_ex = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                sensor_zone_ex += `
  - platform: template
    name: \${entity_name} Zout${i} Target Counts
    id: zone_ex${i}_target_count
    accuracy_decimals: 0
    icon: mdi:account-multiple-minus-outline
    unit_of_measurement: "targets"`;
            }
            
            let targets = '';
            {
            targets = `

  # Target 1
  - platform: template
    name: \${entity_name} Target1 X
    id: target1_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    icon: mdi:focus-field-horizontal
    device_class: distance
  - platform: template
    name: \${entity_name} Target1 Y
    id: target1_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    icon: mdi:focus-field-vertical
  - platform: template
    name: \${entity_name} Target1 Speed
    id: target1_speed
    accuracy_decimals: 2
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
  - platform: template
    name: \${entity_name} Target1 Resolution
    id: target1_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
  
  # Target 2
  - platform: template
    name: \${entity_name} Target2 X
    id: target2_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    icon: mdi:focus-field-horizontal
  - platform: template
    name: \${entity_name} Target2 Y
    id: target2_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    icon: mdi:focus-field-vertical
  - platform: template
    name: \${entity_name} Target2 Speed
    id: target2_speed
    accuracy_decimals: 0
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
  - platform: template
    name: \${entity_name} Target2 Resolution
    id: target2_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance

  # Target 3
  - platform: template
    name: \${entity_name} Target3 X
    id: target3_x
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    icon: mdi:focus-field-horizontal
  - platform: template
    name: \${entity_name} Target3 Y
    id: target3_y
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
    icon: mdi:focus-field-vertical
  - platform: template
    name: \${entity_name} Target3 Speed
    id: target3_speed
    accuracy_decimals: 0
    unit_of_measurement: 'm/s'
    state_class: measurement
    device_class: speed
  - platform: template
    name: \${entity_name} Target3 Resolution
    id: target3_resolution
    accuracy_decimals: 0
    unit_of_measurement: 'mm'
    state_class: measurement
    device_class: distance
  - platform: template
    name: \${entity_name} Target1 Angle
    id: target1_angle
    unit_of_measurement: 'º'
    accuracy_decimals: 1
    icon: mdi:angle-acute
  - platform: template
    name: \${entity_name} Target2 Angle
    id: target2_angle
    accuracy_decimals: 1
    unit_of_measurement: 'º'
    icon: mdi:angle-acute
  - platform: template
    name: \${entity_name} Target3 Angle
    id: target3_angle
    accuracy_decimals: 1
    unit_of_measurement: 'º'
    icon: mdi:angle-acute

light:
  - platform: status_led
    name: \${entity_name} sys_status
    pin: GPIO13
    internal: True
    restore_mode: ALWAYS_OFF
  - platform: binary
    name: \${entity_name} Red Info Light
    output: board_info_ed
    entity_category: diagnostic
    restore_mode: ALWAYS_OFF
    disabled_by_default: True
time:
  - platform: sntp
    id: time_now

output:
  - platform: gpio
    id: board_info_ed
    pin: GPIO12

switch:
#  - platform: factory_reset
#    name: \${entity_name} Factory Reset
#    disabled_by_default: True
#    icon: mdi:heart-broken
#    entity_category: diagnostic
  - platform: template
    name: \${entity_name} Target Enable
    id: target_fn_enable
    optimistic: True
    icon: mdi:target-variant
    entity_category: config
    restore_mode: RESTORE_DEFAULT_ON
  - platform: template
    name: \${entity_name} Zone Enable
    id: zone_fn_enable
    optimistic: True
    icon: mdi:target-variant
    entity_category: config
    restore_mode: RESTORE_DEFAULT_ON`;
            }
            
            let switch_leave_zone = '';
            for (let i = 1; i <= zonesQuitter; i++) {
                switch_leave_zone += `
  - platform: template
    name: \${entity_name} Target must leave Zone${i}
    id: zone${i}_must_leave_enable
    optimistic: True
    icon: mdi:account-cancel
    entity_category: config
    restore_mode: RESTORE_DEFAULT_OFF`;
            }
            
            let switch_zone_ex_enable = '';
            for (let i = 1; i <= zonesExclusion; i++) {
                switch_zone_ex_enable += `
  - platform: template
    name: \${entity_name} Zout${i} Enable
    id: zone_ex${i}_enable
    optimistic: True
    icon: mdi:account-cancel
    entity_category: config
    restore_mode: RESTORE_DEFAULT_OFF`;
            }
            
            let uart = '';
            {
              uart = `
  - platform: template
    name: \${entity_name} Illuminance Fast-Update
    id: bh1750_fast_update
    optimistic: True
    entity_category: diagnostic
    restore_mode: RESTORE_DEFAULT_OFF
    icon: mdi:run-fast
    disabled_by_default: True

button:
  - platform: restart
    icon: mdi:power-cycle
    name: \${entity_name} ESP Reboot
    entity_category: diagnostic

uart:
  id: uart_bus
  tx_pin: 
    number: \${tx_pin_ld2450}
    mode:
      input: true
      pullup: true
  rx_pin: 
    number: \${rx_pin_ld2450}
    mode:
      input: true
      pullup: true
  baud_rate: 256000
  parity: NONE
  stop_bits: 1
  data_bits: 8
  debug:
    direction: BOTH
    dummy_receiver: True
    after:
     delimiter: [0X55, 0XCC]
    sequence:
      - lambda: |-
      
          // Tableaux pour stocker les noms des champs`;
            }
            
            function Template_Gen(deb_str, id_d_str, id_f_str, len) {
              let ret_str = '          static template_::' + deb_str + '[] = {';
              for (let i = 1; i <= len; i++) {
                let id_str = '';
                if (i > 1) id_str += ',';
                id_str += 'id(' + id_d_str + `${i}` + id_f_str + ')';
                ret_str += id_str
              }
              return String(ret_str + '};');
            }
            
            let uart_template = '';
            {
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_x", "zone", "_x", zonesDetection);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_y", "zone", "_y", zonesDetection);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_height", "zone", "_height", zonesDetection);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_width", "zone", "_width", zonesDetection);
              uart_template += '\n' + Template_Gen("TemplateSensor* zone_target_count", "zone", "_target_count", zonesDetection);
              uart_template += '\n' + Template_Gen("TemplateBinarySensor* zone_target_exist", "zone", "_target_exist", zonesDetection);
              uart_template += `
          const int NUM_ZONES = ${zonesDetection};`;
              uart_template += '\n' + Template_Gen("TemplateSwitch* zone_must_leave_enable", "zone", "_must_leave_enable", zonesQuitter);
              uart_template += `
          const int NUM_ZONES_MUST_LEAVE = ${zonesQuitter};`;
              uart_template += '\n' + Template_Gen("TemplateSwitch* zone_ex_enable", "zone_ex", "_enable", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_ex_x", "zone_ex", "_x", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_ex_y", "zone_ex", "_y", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_ex_height", "zone_ex", "_height", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateNumber* zone_ex_width", "zone_ex", "_width", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateSensor* zone_ex_target_count", "zone_ex", "_target_count", zonesExclusion);
              uart_template += '\n' + Template_Gen("TemplateBinarySensor* zone_ex_target_exist", "zone_ex", "_target_exist", zonesExclusion);
              uart_template += `
          const int NUM_ZONES_EX = ${zonesExclusion};`;
              uart_template += '\n' + Template_Gen("TemplateSensor* target_angle", "target", "_angle", 3);
              uart_template += '\n' + Template_Gen("TemplateTextSensor* target_position", "target", "_position", 3);
              uart_template += '\n' + Template_Gen("TemplateTextSensor* target_direction", "target", "_direction", 3);
              uart_template += '\n' + Template_Gen("TemplateSensor* target_x", "target", "_x", 3);
              uart_template += '\n' + Template_Gen("TemplateSensor* target_y", "target", "_y", 3);
              uart_template += '\n' + Template_Gen("TemplateSensor* target_speed", "target", "_speed", 3);
              uart_template += '\n' + Template_Gen("TemplateSensor* target_resolution", "target", "_resolution", 3);
              uart_template += `
          const int NUM_TARGETS = 3;`;
            }
            {
              uart_template += `
          float angle = id(wall_angle).state*1;
          
          struct Position  p[NUM_TARGETS];
          struct Zone zone_ex[NUM_ZONES_EX], zone[NUM_ZONES];
          
          if ((millis() - id(last_update_ld2450)) <= 500) { 
            return;
          };
          id(last_update_ld2450) = millis();

          //Targets' data
          int b = 0;
          for (int i = 0; i < NUM_TARGETS; i++) {
            p[i].x = (uint16_t((bytes[b+5] << 8) | bytes[b+4] ));
            if ((bytes[b+5] & 0x80) >> 7){
              p[i].x -= pow(2, 15); 
            }else{
              p[i].x = 0 - p[i].x;
            }
            p[i].x = p[i].x * -1;

            p[i].y = (uint16_t((bytes[b+7] << 8) | bytes[b+6] ));
            if ((bytes[b+7] & 0x80) >> 7){
              p[i].y -= pow(2, 15);
            }else{
              p[i].y = 0 - p[i].y;
            }

            p[i].speed = (bytes[b+9] << 8 | bytes[b+8] );
            if ((bytes[b+9] & 0x80) >> 7){
              p[i].speed -= pow(2, 15);
            }else{
              p[i].speed = 0 - p[i].speed;
            }
            p[i].distance_resolution = (uint16_t((bytes[b+11] << 8) | bytes[b+10] )); 
            p[i].valide = (p[i].x != 0 || p[i].y > 0);
            b += 8;
          }
          
          // Excluded zones 
          for (int i = 0; i < NUM_ZONES_EX; i++) {
            zone_ex[i].x = zone_ex_x[i]->state;
            zone_ex[i].y = zone_ex_y[i]->state;
            zone_ex[i].width = zone_ex_width[i]->state;
            zone_ex[i].height = zone_ex_height[i]->state;
            //zone_ex[i].tips_conf = tips_zone_ex_conf[i];
            //zone_ex[i].name += "_ex" + std::to_string(i+1);

            if (zone_ex_enable[i]->state){
              for (int j = 0; j < NUM_TARGETS; j++) {
                if (p[j].valide){
                  if (check_targets_in_zone(zone_ex[i], p[j], angle)){
                    zone_ex[i].target_count++;
                    p[j].zone_ex_enter = true;
                  } else { 
                    zone_ex[i].outside_target_count++;
                  }
                }
              }
            }
            zone_ex[i].has_target = (zone_ex[i].target_count > 0);
            zone_ex[i].has_target_outside = (zone_ex[i].outside_target_count > 0);
          }
          
          // all targets
          int16_t all_target_counts = 0;
          for (int i = 0; i < NUM_TARGETS; i++) {
            if (p[i].valide && !p[i].zone_ex_enter){
              all_target_counts ++;
            }
          }

          bool has_target_in_zone_all = (all_target_counts > 0);

          // zones check
          if (id(zone_fn_enable).state){
            for (int i = 0; i < NUM_ZONES; i++) {
              zone[i].x = zone_x[i]->state;
              zone[i].y = zone_y[i]->state;
              zone[i].width = zone_width[i]->state;
              zone[i].height = zone_height[i]->state;
              //zone[i].tips_conf = tips_zone_conf[i];
              //zone[i].name += std::to_string(i+1);
              
              for (int j = 0; j < NUM_TARGETS; j++) {
                if (p[j].valide && !p[j].zone_ex_enter){
                  if(check_targets_in_zone(zone[i], p[j], angle)) {
                    zone[i].target_count++;
                  } else { 
                    zone[i].outside_target_count++;
                  }
                }
              }
              zone[i].has_target = (zone[i].target_count > 0);
              zone[i].has_target_outside = (zone[i].outside_target_count > 0);
            }
          }`;
            }
            {
              uart_template += `

          // Angle, Position and Direction, idea from walberjunior.
          for (int i = 0; i < NUM_TARGETS; i++) {
            if (p[i].valide){
              p[i].angle = ((float)p[i].x / (float)p[i].y) * 180 / M_PI;;
            }
            if (target_angle[i]->state != p[i].angle && id(target_fn_enable).state){
              target_angle[i]->publish_state(p[i].angle);
            }

            if (p[i].speed > 0) {
              p[i].position = "Moving away";
            } else if (p[i].speed < 0) {
              p[i].position = "Approaching";
            } 
            if (p[i].position != target_position[i]->state && id(target_fn_enable).state){
              target_position[i]->publish_state(p[i].position);
            }

            if (p[i].x > 0) {
              p[i].direction = "Right";
            } else if (p[i].x < 0) {
              p[i].direction = "Left";
            } else if (p[i].y > 0){
              p[i].direction = "Middle";
            }
            if (p[i].direction != target_direction[i]->state && id(target_fn_enable).state){
              target_direction[i]->publish_state(p[i].direction);
            }
          }

          // public all info
          for (int i = 0; i < NUM_TARGETS; i++) {
            if (target_x[i]->state != p[i].x && id(target_fn_enable).state){
              target_x[i]->publish_state(p[i].x);
            }
            if (target_y[i]->state != p[i].y && id(target_fn_enable).state){
              target_y[i]->publish_state(p[i].y);
            }

            p[i].speed = float(p[i].speed) / 100.0;
            if (target_speed[i]->state != p[i].speed && id(target_fn_enable).state){
              target_speed[i]->publish_state(p[i].speed);
            }
            if (target_resolution[i]->state != p[i].distance_resolution && id(target_fn_enable).state){
              target_resolution[i]->publish_state(p[i].distance_resolution);
            }
          }

          // publish target and zone info
          if (id(all_target_count).state != all_target_counts){
            id(all_target_count).publish_state(all_target_counts);
            id(any_target_exist).publish_state(has_target_in_zone_all);
          }else if (id(any_target_exist).state != has_target_in_zone_all){
            id(any_target_exist).publish_state(has_target_in_zone_all);
          }`;
            }
            {
              uart_template += `

          bool pub;
          for (int i = 0; i < NUM_ZONES; i++) {
            if (zone_target_count[i]->state != zone[i].target_count){
              pub = false;
              if (i >= NUM_ZONES_MUST_LEAVE)
                pub = true;
              else if ((!zone_must_leave_enable[i]->state) || (zone_must_leave_enable[i]->state && (zone[i].has_target || zone[i].has_target_outside))) {
                pub = true;
              }
              if (pub) {
                zone_target_count[i]->publish_state(zone[i].target_count);
                zone_target_exist[i]->publish_state(zone[i].has_target);
              }
            }
          }
          for (int i = 0; i < NUM_ZONES_EX; i++) {
            if (zone_ex_target_count[i]->state != zone_ex[i].target_count){
              zone_ex_target_count[i]->publish_state(zone_ex[i].target_count);
            }
            if (zone_ex_target_exist[i]->state != zone_ex[i].has_target){
              zone_ex_target_exist[i]->publish_state(zone_ex[i].has_target);
            }
          }

          if (!id(init_zone_publish)){
            id(init_zone_publish) = true;
          }`;
            }        
            
            let zone_h_text = '';
            {
                zone_h_text += `#include <cmath>
#include <iostream>
#include <sstream>
#include <string>
#include <iomanip>
#include <algorithm>
#include <cctype>

struct Position {
  int16_t x; 
  int16_t y;
  int speed;
  int16_t distance_resolution;
  bool valide;
  bool zone_ex_enter = false;
  float angle = 0;
  std::basic_string<char> position = "Static";
  std::basic_string<char> direction = "None";
};
struct Zone {
  int16_t x;
  int16_t y;
  int16_t height;
  int16_t width;
  int16_t target_count = 0;
  int16_t outside_target_count = 0;
  bool has_target = false;
  bool has_target_outside = false;
};

struct Pxy {
  int16_t x; 
  int16_t y;
};

// Définition de la fonction pour vérifier les cibles dans une zone donnée
bool check_targets_in_zone(struct Zone &z, struct Position &t, float angle) {
  struct Pxy p1, p2, p3, p4;
  float d12, d14, d15, d23, d25, d34, d35, d45; 
  float a152, a154, a253, a354, a_sum;
  float TAU = 6.283185; // 2*PI
  bool isInside = false;
  
  p1.x = z.x;
  p1.y = z.y;
  p2.x = z.x - z.width * cos(angle*PI/180);
  p2.y = z.y + z.width * sin(angle*PI/180);
  p3.x = z.x - z.width * cos(angle*PI/180) + z.height * cos((angle-90)*PI/180);
  p3.y = z.y + z.width * sin(angle*PI/180) + z.height * sin((angle+90)*PI/180);
  p4.x = z.x + z.height * cos((angle-90)*PI/180);
  p4.y = z.y + z.height * sin((angle+90)*PI/180);
  
  d15 = sqrt(pow(p1.x-t.x,2)+pow(p1.y-t.y,2));
  d25 = sqrt(pow(p2.x-t.x,2)+pow(p2.y-t.y,2));
  d35 = sqrt(pow(p3.x-t.x,2)+pow(p3.y-t.y,2));
  d45 = sqrt(pow(p4.x-t.x,2)+pow(p4.y-t.y,2));
  d12 = sqrt(pow(p1.x-p2.x,2)+pow(p1.y-p2.y,2));
  d14 = sqrt(pow(p1.x-p4.x,2)+pow(p1.y-p4.y,2));
  d23 = sqrt(pow(p2.x-p3.x,2)+pow(p2.y-p3.y,2));
  d34 = sqrt(pow(p3.x-p4.x,2)+pow(p3.y-p4.y,2));
  
  a152 = acos((pow(d15,2)+pow(d25,2)-pow(d12,2))/(2*d15*d25));
  a154 = acos((pow(d15,2)+pow(d45,2)-pow(d14,2))/(2*d15*d45));
  a253 = acos((pow(d25,2)+pow(d35,2)-pow(d23,2))/(2*d25*d35));
  a354 = acos((pow(d35,2)+pow(d45,2)-pow(d34,2))/(2*d35*d45));
  a_sum = a152+a154+a253+a354;
  
  if (a_sum>=TAU) {
    isInside = true;
  }
  return isInside;
}

bool to_bool(std::basic_string<char> str) {
    std::transform(str.begin(), str.end(), str.begin(), ::tolower);
    std::istringstream is(str);
    bool b;
    is >> std::boolalpha >> b;
    return b;
}`;
            }
            
            let graph_deb = '';
            {
              graph_deb = `type: custom:plotly-graph
title: "${friendly_name}:\_LD2450"
refresh_interval: 2
hours_to_show: current_day
ha_theme: true
layout:
  legend:
    'y': 8000
    orientation: h
  autosize: true
  margin:
    autoexpand: true
    l: 50
    r: 20
    t: 20
    b: 40
  showlegend: true
  xaxis:
    dtick: 1000
    gridcolor: RGBA(200,200,200,0.15)
    zerolinecolor: RGBA(200,200,200,0.15)
    type: number
    fixedrange: true
    range:
      - -4000
      - 4000
  yaxis:
    dtick: 1000
    gridcolor: RGBA(200,200,200,0.15)
    zerolinecolor: RGBA(200,200,200,0.15)
    scaleanchor: x
    scaleratio: 1
    fixedrange: true
    range:
      - 8000
      - 0
entities:
  - entity: ''
    name: Person1
    show_value: true
    unit_of_measurement: mm
    marker:
      size: 12
    line:
      shape: spline
      width: 5
    x:
      - $ex hass.states["sensor.${for_graph_low}_target1_x"].state
    'y':
      - $ex hass.states["sensor.${for_graph_low}_target1_y"].state
  - entity: ''
    name: Person2
    show_value: true
    unit_of_measurement: mm
    marker:
      size: 12
    line:
      shape: spline
      width: 5
    x:
      - $ex hass.states["sensor.${for_graph_low}_target2_x"].state
    'y':
      - $ex hass.states["sensor.${for_graph_low}_target2_y"].state
  - entity: ''
    name: Person3
    show_value: true
    unit_of_measurement: mm
    marker:
      size: 12
    line:
      shape: spline
      width: 5
    x:
      - $ex hass.states["sensor.${for_graph_low}_target3_x"].state
    'y':
      - $ex hass.states["sensor.${for_graph_low}_target3_y"].state`;
            }
            
            let graph_zone = '';
            let coul_graph_zone = ['0,250,0', '250,110,0', '0,0,250', '250,210,0', '0,150,0', '250,50,130', '0,250,0', '250,110,0', '0,0,250', '250,210,0'];
            for (let i = 1; i <= zonesDetection; i++) {
                graph_zone += `
  - entity: ''
    name: Zone${i}
    mode: lines
    fill: toself
    fillcolor: >-
      $ex hass.states["binary_sensor.${for_graph_low}_zone${i}_presence"].state == "on" ?
      "RGBA(${coul_graph_zone[i-1]},0.4)" : "RGBA(${coul_graph_zone[i-1]},0.1)"
    line:
      color: RGBA(${coul_graph_zone[i-1]},0.9)
      shape: line
      width: 2
    x:
      - $ex hass.states["number.${for_graph_low}_zone${i}_x"].state*1
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_x"].state*1 -
        hass.states["number.${for_graph_low}_zone${i}_width"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_x"].state*1 -
        hass.states["number.${for_graph_low}_zone${i}_width"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180) +
        hass.states["number.${for_graph_low}_zone${i}_height"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state*1-90)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_x"].state*1 +
        hass.states["number.${for_graph_low}_zone${i}_height"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state*1-90)*3.1415/180)
      - $ex hass.states["number.${for_graph_low}_zone${i}_x"].state*1
    'y':
      - $ex hass.states["number.${for_graph_low}_zone${i}_y"].state*1
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zone${i}_width"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zone${i}_width"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180) +
        hass.states["number.${for_graph_low}_zone${i}_height"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state*1+90)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zone${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zone${i}_height"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state*1+90)*3.1415/180)
      - $ex hass.states["number.${for_graph_low}_zone${i}_y"].state*1`;
            }
            
            let graph_zone_ex = '';
            let coul_graph_zone_ex = ['0,150,0', '250,110,0', '0,0,250', '0,150,0', '250,110,0', '0,0,250', '0,150,0', '250,110,0', '0,0,250', '0,150,0'];
            for (let i = 1; i <= zonesExclusion; i++) {
              graph_zone_ex += `
  - entity: ''
    name: Zout${i}
    mode: lines
    fill: toself
    fillcolor: >-
      $ex hass.states["switch.${for_graph_low}_zout${i}_enable"].state == "on" ?
      hass.states["binary_sensor.${for_graph_low}_zout${i}_presence"].state == "on" ?
      "RGBA(250,0,0,0.4)" : "RGBA(250,0,0,0.2)" : "RGBA(0,0,0,0)"
    line:
      color: >-
        $ex hass.states["switch.${for_graph_low}_zout${i}_enable"].state == "on" ?
        "RGBA(${coul_graph_zone_ex[i-1]},0.9)" : "RGBA(0,0,0,0)" 
      width: 3
      dash: dash
    x:
      - $ex hass.states["number.${for_graph_low}_zout${i}_x"].state*1
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_x"].state*1 -
        hass.states["number.${for_graph_low}_zout${i}_width"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_x"].state*1 -
        hass.states["number.${for_graph_low}_zout${i}_width"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180) +
        hass.states["number.${for_graph_low}_zout${i}_height"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state*1-90)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_x"].state*1 +
        hass.states["number.${for_graph_low}_zout${i}_height"].state *
        Math.cos((hass.states["number.${for_graph_low}_angle"].state*1-90)*3.1415/180)
      - $ex hass.states["number.${for_graph_low}_zout${i}_x"].state*1
    'y':
      - $ex hass.states["number.${for_graph_low}_zout${i}_y"].state*1
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zout${i}_width"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zout${i}_width"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state)*3.1415/180) +
        hass.states["number.${for_graph_low}_zout${i}_height"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state*1+90)*3.1415/180)
      - >-
        $ex hass.states["number.${for_graph_low}_zout${i}_y"].state*1 +
        hass.states["number.${for_graph_low}_zout${i}_height"].state *
        Math.sin((hass.states["number.${for_graph_low}_angle"].state*1+90)*3.1415/180)
      - $ex hass.states["number.${for_graph_low}_zout${i}_y"].state*1`;
            } 
            let graph_fin = '';
            {
              graph_fin += `
  - entity: ''
    name: Coverage
    mode: lines
    line:
      width: 1
      color: rgba(100, 100, 100, .6)
      dash: dot
    x:
      - 0
      - 1000
      - 3700
      - 3500
      - 2000
      - 0
      - -2000
      - -3500
      - -3700
      - -1000
      - 0
    'y':
      - 0
      - 500
      - 3700
      - 6000
      - 7400
      - 8000
      - 7400
      - 6000
      - 3700
      - 500
      - 0
raw_plotly_config: true`;
            }
            
            /******** YAML **********/
            // Fusionner les textes générés
            const finalYamlText1 = entete + zonesDetectionText + zonesExclusionText + text_sensor_target + number_zone_Timeout + number_zone + number_zone_ex;
            const finalYamlText2 = binary_sensor + binary_sensor_zone + binary_sensor_zone_ex + check_zone + check_zone_ex + sensor_zone + sensor_zone_ex;
            const finalYamlText3 = targets + switch_leave_zone + switch_zone_ex_enable + uart + uart_template;
            const finalYamlText = finalYamlText1 + finalYamlText2 + finalYamlText3;

            // Afficher le texte généré dans la zone de texte
            const generatedYamlTextArea = document.getElementById('generated-yaml-text');
            generatedYamlTextArea.textContent = finalYamlText;
            generatedYamlTextArea.style.display = 'block'; // Afficher le texte

            // Afficher le lien de téléchargement
            const downloadYamlLink = document.getElementById('download-yaml-link');
            downloadYamlLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(finalYamlText);
            downloadYamlLink.style.display = 'block'; // Afficher le lien

            // Mettre à jour le nom de fichier téléchargé
            downloadYamlLink.setAttribute('download', `LD2450.yaml`);
            
            /******** Librairie **********/
            // Afficher le texte généré dans la zone de texte
            const zoneHTextArea = document.getElementById('zone-h-text');
            zoneHTextArea.textContent = zone_h_text;
            zoneHTextArea.style.display = 'block'; // Afficher le texte

            // Afficher le lien de téléchargement
            const zoneHLink = document.getElementById('download-zone-link');
            zoneHLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(zone_h_text);
            zoneHLink.style.display = 'block'; // Afficher le lien

            // Mettre à jour le nom de fichier téléchargé
            zoneHLink.setAttribute('download', `zone.h`);
            
            /******** GRAPH **********/
             // Fusionner les textes générés
            const finalGraphText = graph_deb + graph_zone + graph_zone_ex + graph_fin;

            // Afficher le texte généré dans la zone de texte
            const generatedGraphTextArea = document.getElementById('generated-graph-text');
            generatedGraphTextArea.textContent = finalGraphText;
            generatedGraphTextArea.style.display = 'block'; // Afficher le texte

            // Afficher le lien de téléchargement
            const downloadGraphLink = document.getElementById('download-graph-link');
            downloadGraphLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(finalYamlText);
            downloadGraphLink.style.display = 'block'; // Afficher le lien

            // Mettre à jour le nom de fichier téléchargé
            downloadGraphLink.setAttribute('download', `Plotly Graph.txt`);
            });
            // Convertir le texte entré dans le premier champ en minuscules et remplacer les espaces par des tirets
            document.getElementById('devicename').addEventListener('input', function () {
                const deviceNameInput = document.getElementById('devicename');
                deviceNameInput.value = deviceNameInput.value.toLowerCase().replace(/ /g, '-');
            });
            document.getElementById('entity_name').addEventListener('input', function () {
                const devicename = document.getElementById('devicename').value;
                const friendly_name = document.getElementById('friendly_name').value;
                const entity_name = document.getElementById('entity_name').value;
                const forGraphInput = document.getElementById('for_graph');
                
                let tmp = devicename.toLowerCase() + '_' + entity_name.toLowerCase();
                forGraphInput.value =  tmp.replace(/[-\s]+/g, '_').replace(/_+/g, '_').replace(/_$/g, '');
            });
        });
    </script>
</body>
</html>
